<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css" />
  <title>Detail</title>

  <style>

  </style>
  <script>

    let id = `{{ p_id }}`;
    console.log(id);
    $(document).ready(function () {
      getData();
    });

    // console.log(id);
    function postingcomment() {

      let writer = $('#writer').val();
      let comment = $('#comment').val();

      let formData = new FormData();

      formData.append('name_give', writer);
      formData.append('comment_give', comment);

      fetch(`/posts/${id}/comments`, { method: 'POST', body: formData })
        .then((res) => res.json())
        .then((data) => {
          alert(data['msg']);
          window.location.reload();
        });
    }

    //ê²Œì‹œê¸€, ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸°
    function getData() {

      //ê²Œì‹œê¸€ ë¶€ë¶„
      fetch(`/posts/detail/${id}`)
        .then((res) => res.json())
        .then((data) => {
          $('.body-title-head').empty();
          $('.body-write').empty();
          $('.body-text').empty();
          let a = data['result'];
          let title = a['title'];
          let desc = a['comment'];
          let image = a['image'];
          let comment = a['comment'];
          let writer = a['user_id'];
          let category = a['category'];
          let reg_date = a['reg_date'];
          let url = a['url'];
          var like = a['like'];

          let jsDate = new Intl.DateTimeFormat('kr').format(new Date(reg_date))

          var cate = ""

          switch (category) {
            case 'movie':
              cate = 'ì˜í™”';
              break;
            case 'music':
              cate = 'ìŒì•…';
              break;
            case 'health':
              cate = 'ìš´ë™';
              break;
            case 'ani':
              cate = 'ì• ë‹ˆ';
              break;
            case 'book':
              cate = 'ì±…';
              break;
          }
          $('#changeLogo').text(cate);

          $('#detailImg').attr('src', image);

          let detail_title = `<h1 class="title-text">${title}</h1>
            <img src="/static/src/img/underline_black.png" class="underline" alt="">`
          $('.body-title-head').append(detail_title);

          let detail_writer = `
                                <div class="write-er">
                                 <p>ğŸ“${writer}</p>
                                </div>
                                <div class="write-date-time">
                                  <p>ğŸ“…${jsDate}</p>
                                </div>`
          $('.body-write').append(detail_writer);

          let detail_comment = `<p>${comment}</p>`
          $('.body-text').append(detail_comment);

          let tmp_html = `<div class="heart">
                              <button class="heart-btn" onclick="addLike(${like})">
                                <i class="far fa-heart fa-2x"></i>
                              </button>
                              <div class="like_count">ì¢‹ì•„ìš” ${like}ê°œ</div>
                            </div>`;
          $('.tmp').append(tmp_html);
        });

      //ëŒ“ê¸€ ë¶€ë¶„
      fetch(`/posts/${id}/comments`)
        .then((res) => res.json())
        .then((data) => {
          console.log(data);
          $('#replyBox').empty();
          let rows = data['result'];
          rows.forEach((a) => {
            let r_id = a['_id'];
            let user_id = a['user_id'];
            let comment = a['comment'];
            let reg_date = a['reg_date'];

            let temp_html = `<div class="reply-data" id="reply${r_id}">
                                      <input id="replyName${r_id}" value="${user_id}" style="font-weight: bolder;" disabled/> 
                                      <input id="replyComment${r_id}" value="${comment}" disabled/>
                                      <p style="color: gray;">(${reg_date})</p>
                                      <div id="reply-edit-btn${r_id}"><button id="${r_id}" onclick="modifycomment(this)" >ìˆ˜ì •</button></div>
                                      <div id="reply-del-btn"><button onclick="deletecomment('${r_id}')" class="reply-del-btn${r_id}">ì‚­ì œ</button></div>
                                      <div id="reply-edited-btn${r_id}" style="display: none"><button id="${r_id}" onclick="modifyReply(this)" class="reply-edited-btn">ìˆ˜ì •ì™„ë£Œ</button></div>
                                      <div id="reply-editFin-btn${r_id}"><button onclick="replyRe()" style="display: none" class="reply-editedFin-btn">ì·¨ì†Œ</button></div>
                                  </div>`;
            $('#replyBox').append(temp_html);
          });
        });
    }
    // ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë‹¬ ì •ë³´ ì§‘ì–´ë„£ê¸°
    function getmodifyData() {
        fetch(`/posts/detail/${id}`)
          .then((res) => res.json())
          .then((data) => {
            let row = data['result'];
            let category = row['category'];
            let title = row['title'];
            let comment = row['comment'];
            let user_id = row['user_id'];
            let url = row['image'];
            let urlsite = row['url'];

            $('#cateBox').val(category).prop('selected', true);
            $('#titleBox').attr('value', title);
            // $('#urlBox').attr('value', url);
            console.log(urlsite);

            console.log(category);
            console.log(typeof category);
            category == 'book' || category == 'music'
              ? $('#urlBox').attr('value', urlsite)
              : $('#urlBox').attr('value', url);
            $('#writerBox').attr('value', user_id);
            $('#commentBox').attr('value', comment);

            // if (category === 'book' || category === 'music') {
            //   $('#urlBox').attr('value', urlsite);
            // } else {
            //   $('#urlBox').attr('value', url);
            // }
          });
      }
   // ê²Œì‹œê¸€ ìˆ˜ì •
   function modifypost() {
        let url = $('#urlBox').val();
        let comment = $('#commentBox').val();
        let writer = $('#writerBox').val();
        let category = $('#cateBox').val();
        let title = $('#titleBox').val();
        console.log(url);

        let formData = new FormData();
        formData.append('url_give', url);
        formData.append('comment_give', comment);
        formData.append('nickname_give', writer);
        formData.append('category_give', category);
        formData.append('title_give', title);

        fetch(`/posts/${id}`, { method: 'PUT', body: formData })
          .then((res) => res.json())
          .then((data) => {
            alert(data['msg']);
            window.location.reload();
          });
      }

    //ê²Œì‹œê¸€ ì‚­ì œ
    function deletepost() {
      fetch(`/posts/${id}`, {
        method: 'DELETE',
      })
        .then((res) => res.json())
        .then((data) => {
          alert(data['msg']);

          // â­ï¸ í˜ì´ì§€ ì¬ë¡œë”©
          window.location.href = '/';
        });
    }

    //ëŒ“ê¸€ ìˆ˜ì • ê°€ëŠ¥ìƒíƒœë¡œ ë³€ê²½
    function modifycomment(e) {
        let id = $(e).attr('id');
        $(`#reply-edit-btn${id}`).empty();
        $(`#reply-edited-btn${id}`).show();
        $(`#replyName${id}`).removeAttr('disabled');
        $(`#replyComment${id}`).removeAttr('disabled');
        $(`#replyName${id}`).focus();
        $(`#replyComment${id}`).focus();

        let editFin = `<button onclick="replyRe()" class="reply-editedFin-btn">ì·¨ì†Œ</button>`;
        $(`#reply-editFin-btn${id}`).append(editFin);
      }

      function modifyReply(e) {
      let r_id = $(e).attr('id');
      let name = $(`#replyName${r_id}`).val();
      let comment = $(`#replyComment${r_id}`).val();

      let formData = new FormData();
      formData.append('name_give', name);
      formData.append('comment_give', comment);
      fetch(`/posts/comments/${r_id}`, {
      method: 'PUT',
      body: formData,
      })
      .then((res) => res.json())
      .then((data) => {
      alert(data['msg']);

      window.location.reload();
      });
      }

    //ëŒ“ê¸€ ì‚­ì œ
    function deletecomment(r_id) {

      fetch(`/posts/comments/${r_id}`, {
        method: 'DELETE',
      })
        .then((res) => res.json())
        .then((data) => {
          alert(data['msg']);

          window.location.reload();
        });
    }

    function open_box() {
      $('#post-box').show()
    }
    function close_box() {
      $('#post-box').hide()
    }

    function back() {
      history.back();
    }

    function moving(e) {
      let category = $(e).attr('id');

      window.location.href = '/posts/' + category;
    }

    //ê²Œì‹œê¸€ ì¢‹ì•„ìš” ë¶€ë¶„

    function countPlus(likeCnt) {
      likeCnt++;
      document.querySelector(".like_count").innerHTML = "ì¢‹ì•„ìš” " + likeCnt + "ê°œ";

      //ê²Œì‹œê¸€ ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ í˜¸ì¶œ
      updateLike(likeCnt);
    }

    function addLike(likeCnt) {
      const pushHeartBtn = document.querySelector(".heart-btn");
        pushHeartBtn.innerHTML = '<i class="fas fa-heart fa-2x"></i>';
        pushHeartBtn.style.color = 'red';
        pushHeartBtn.addEventListener("click", countPlus(likeCnt));
    }

    //ê²Œì‹œê¸€ ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸
    function updateLike(count) {

      let formData = new FormData();
      formData.append('like_give', count);

      fetch(`/posts/like/` + id, {
        method: 'PUT',
        body: formData,
      })
        .then((res) => res.json())
        .then((data) => {
          alert(data['msg']);

          // window.location.reload();
        });
    }


    function replyRe() {
      window.location.reload()
    }

  </script>
</head>

<body>
  <!-- ìˆ˜ì • ëª¨ë‹¬ í¼ ì‹œì‘ -->
  <div class="black-bg">
    <div class="white-bg">
      <h1 style="text-align: center; font-family: PyeongChangPeace-Bold">
        'ì·¨í–¥'ì€ ì–¸ì œë“  ë³€í•˜ì£ !
      </h1>

      <form action="#">
        <div class="write-box">
          <div class="write-box-inside">
            <p>ì¹´í…Œê³ ë¦¬</p>
            <form>
              <select id="cateBox" size="1">
                <option value="movie">ì˜í™”</option>
                <option value="music">ìŒì•…</option>
                <option value="ani">ì• ë‹ˆ</option>
                <option value="health">ìš´ë™</option>
                <option value="book">ì±…</option>
              </select>
            </form>
          </div>
          <div class="write-box-inside">
            <p>íƒ€ì´í‹€</p>
            <form>
              <input type="text" id="titleBox" class="text-box" placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" />
            </form>
          </div>
          <div class="write-box-inside">
            <p>URL</p>
            <form>
              <input type="text" id="urlBox" class="text-box" placeholder="URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”" />
            </form>
          </div>
          <div class="write-box-inside">
            <p>ì‘ì„±ì</p>
            <form>
              <input type="text" id="writerBox" class="text-box" placeholder="ì‘ì„±ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" />
            </form>
          </div>
          <div class="write-box-inside">
            <p>ì½”ë©˜íŠ¸</p>
            <form>
              <input type="text" id="commentBox" class="text-box" style="height: 200px"
                placeholder="ì·¨í–¥ì— ëŒ€í•œ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”" />
            </form>
          </div>
          <div style="clear: both"></div>
        </div>
        <div style="text-align: center">
          <button type="submit" class="write-btn send-btn" id="send" onclick="modifypost()">
            ìˆ˜ì •ì™„ë£Œ
          </button>
          <button type="button" class="write-btn close-btn" id="close">
            ì·¨ì†Œ
          </button>
        </div>
      </form>
    </div>
  </div>
  <!-- ìˆ˜ì • ëª¨ë‹¬ í¼ ë -->
  <div class="contentContainer">
    <div class="headerWrap">
      <div class="memberHeader">
        <a onclick="window.location.href='/'">
          <img src="/static/src/img/logo_image.png" class="logo" alt="">
        </a>
        <p id="changeLogo"></p>
        <div class="memberBtn">
          <!-- <button>íšŒì›ê°€ì…</button>
          <button>ë¡œê·¸ì¸</button> -->
          <button id="logout">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </div>
    <div class="background">
      <div class="left-navbar">
        <div class="left-navbar-menu">
          <p>category</p>
        </div>
        <div class="left-navbar-content">
          <div class="category" id="category-1"><a id="movie" onclick="moving(this)">
              <img src="/static/src/img/circle.png" class="circle1" alt="">
              <div>ì˜í™” ğŸ¬</div>
            </a>
          </div>
          <div class="category" id="category-2"><a id="music" onclick="moving(this)">
              <img src="/static/src/img/circle.png" class="circle2" alt="">
              <div>ìŒì•… ğŸ§</div>
            </a>
          </div>
          <div class="category" id="category-3"><a id="ani" onclick="moving(this)">
              <img src="/static/src/img/circle.png" class="circle3" alt="">
              <div>ì• ë‹ˆ ğŸ“º</div>
            </a>
          </div>
          <div class="category" id="category-4"><a id="health" onclick="moving(this)">
              <img src="/static/src/img/circle.png" class="circle4" alt="">
              <div>ìš´ë™ âš½</div>
            </a>
          </div>
          <div class="category" id="category-5"><a id="book" onclick="moving(this)">
              <img src="/static/src/img/circle.png" class="circle5" alt="">
              <div>ì±… ğŸ“š</div>
            </a>
          </div>
        </div>
      </div>
      <!-- ìƒì„¸í˜ì´ì§€ í¼ -->
      <div class="body">
        <div class="body-title">
          <div class="body-title-head">
            <h1 class="title-text" id="detailtitle">ë‰´ì§„ìŠ¤ì˜ í•˜ì…ë³´ì´ìš”</h1>
            <img src="/static/src/img/underline_black.png" class="underline" alt="">
          </div>
          <div class="body-write">
            <div class="write-er">
              <p>ğŸ“ì‹ ìƒ˜</p>
            </div>
            <div class="write-date-time">
              <p>ğŸ“…2023.03.28 21:30</p>
            </div>
          </div>
          <div style="float: none; clear: both;"></div>
        </div>
        <div class="body-detail">
          <div class="body-img">
            <img
              src="https://img1.daumcdn.net/thumb/R1280x0.fjpg/?fname=http://t1.daumcdn.net/brunch/service/user/epXm/image/WTEOnfO6X44JawwreKjDtHTO7EI.jfif"
              class="image" alt="" id="detailImg">
          </div>
          <div class="body-text">
            <p>(1,2,3,4)
              Baby, got me looking so crazy
              ë¹ ì ¸ë²„ë¦¬ëŠ” daydream
              Got me feeling you
              ë„ˆë„ ë§í•´ì¤„ë˜
            </p>
          </div>
        </div>
        <div class="tmp " style="float:none; clear:both;"></div>
        <!-- =====ì¢‹ì•„ìš”ë²„íŠ¼ê³¼ ê°œìˆ˜============= -->
        <!-- ======================= -->
        <div style="float:none; clear:both;"></div>
        <div class="body-btn">
          <button class="list-btn" onclick="back()">ëª©ë¡</button>
          <button class="edit-btn">ìˆ˜ì •</button>
          <button class="del-btn" onclick="deletepost()">ì‚­ì œ</button>
        </div>
        <div class="reply">
          <!-- ===ëŒ“ê¸€ì‘ì„±===================== -->
          <div class="reply-box">
            <input type="text" class="reply-name" id="writer" placeholder="ì‘ì„±ì"><br>
            <input type="text" class="reply-text" id="comment" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!">
            <button class="reply-btn" onclick="postingcomment()">ëŒ“ê¸€ ë‚¨ê¸°ê¸°<br>ğŸ’¬</button>
          </div>
          <!-- ===ëŒ“ê¸€============= -->
          <div id="replyBox"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    $('.edit-btn').on('click', function () {
      $('.black-bg').addClass('show-modal');
      getmodifyData();
    });
    $('#close').on('click', function () {
      $('.black-bg').removeClass('show-modal');
      window.location.reload();
    });


    $('#category-1').hover(function () {
      $('.circle1').addClass('circle-show');
    }, function () {
      $('.circle1').removeClass('circle-show')
    });

    $('#category-2').hover(function () {
      $('.circle2').addClass('circle-show');
    }, function () {
      $('.circle2').removeClass('circle-show')
    });

    $('#category-3').hover(function () {
      $('.circle3').addClass('circle-show');
    }, function () {
      $('.circle3').removeClass('circle-show')
    });

    $('#category-4').hover(function () {
      $('.circle4').addClass('circle-show');
    }, function () {
      $('.circle4').removeClass('circle-show')
    });

    $('#category-5').hover(function () {
      $('.circle5').addClass('circle-show');
    }, function () {
      $('.circle5').removeClass('circle-show')
    });

  </script>

  <script type='text/javascript'>
    const delete_elements = document.getElementsByClassName("delete");
    Array.from(delete_elements).forEach(function (element) {
      element.addEventListener('click', function () {
        if (confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          location.href = this.dataset.uri;
        };
      });
    });
  </script>
</body>

</html>